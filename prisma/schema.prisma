// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}
enum Deployment {
  CLOUD
  SELF_HOSTED
  HYBRID
}

enum PricingModel {
  SUBSCRIPTION
  USAGE_BASED
  FREEMIUM
  ONE_TIME
  TIERED
}

enum SalesMotion {
  PRODUCT_LED
  SALES_LED
  ENTERPRISE
  SELF_SERVE
  MIXED
}

model Project {
  id              String        @id @default(cuid())
  userId          String?
  user            User?          @relation(fields: [userId], references:[id])
  teamId          String?
  team            Team?          @relation(fields: [teamId], references:[id])
  name            String
  category        String?
  description     String?
  createdAt       DateTime      @default(now())

  // New "open to all industries" fields
  industry        String?       // e.g., "Fintech", "DevTools", "Ecommerce", "Healthcare"
  subIndustry     String?       // e.g., "Payments", "Observability", "Email Marketing"
  targetSegments  String[]      // e.g., ["SMB", "Mid-market", "Enterprise"], ["Developers"]
  regions         String[]      // e.g., ["US", "EU", "APAC"]
  deployment      Deployment?
  pricingModel    PricingModel?
  salesMotion     SalesMotion?
  complianceNeeds String[]      // e.g., ["SOC 2", "HIPAA", "GDPR"]
  projectInputs   ProjectInput[]
  inputs          Json?
  runs            Run[]
  reports         Report[]
  comments        Comment[]
  activities      Activity[]
  approvalWorkflows ApprovalWorkflow[]
  sharedReports   ReportShare[]
}


model Capability {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id])
  category  String   // e.g., "Integrations", "Security", "Compliance", "API", "Performance"
  name      String
  competitorCapabilities  CompetitorCapability[]
  normalized String
}

model CompetitorCapability {
  id            String   @id @default(cuid())
  runId         String
  run           Run      @relation(fields: [runId], references: [id])
  competitorId  String?
  competitor    Competitor? @relation(fields: [competitorId], references: [id])
  capabilityId  String
  capability    Capability @relation(fields: [capabilityId], references: [id])
  evidenceId    String?
  present       Boolean  @default(true)
}

model Integration {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id])
  name      String
  vendor    String?
  category  String?  // e.g., "CRM", "Payments", "Analytics"
  url       String?
}

model ComplianceItem {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id])
  framework String   // "SOC 2", "GDPR", "HIPAA", "PCI-DSS"
  status    String?  // "Compliant", "Claims compliant", "Roadmap"
  notes     String?
}
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects      Project[]
  teamMembers   TeamMember[]
  comments      Comment[]
  activities    Activity[]
  notifications Notification[]
  emailPreferences EmailPreferences?
  sharedReports ReportShare[]
}


model ProjectInput {
  id          String   @id @default(cuid())
  projectId   String   @unique
  problem     String?
  solution    String?
  project     Project    @relation(fields: [projectId], references: [id])
  notes       String?  // reviewer notesd
  platforms   String[]
  priceTarget String?
  keywords    String[]
  competitors String[]
  urls        String[]
}

model Run {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  status      String   @default("PENDING") // PENDING, DISCOVERING, EXTRACTING, SYNTHESIZING, QA, COMPLETE, FAILED
  startedAt   DateTime?
  createdAt   DateTime @default(now())
  completedAt DateTime?
  qaSummary   String?
  qaIssue     String?
  lastNote    String?  // reviewer notes
  competitorCapabilities  CompetitorCapability[]
  capabilities  Capability[]
  sources     Source[]
  competitors Competitor[]
  features    Feature[]
  evidences   Evidence[]
  pricing     PricingPoint[]
  findings    Finding[]
  reports     Report[]
  integrations  Integration[]
  complianceItems ComplianceItem[]
  logs        RunLog[]
  aiInsights  AIInsight[]
}


model Source {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id])
  url       String
  title     String?
  domain    String?
  fetchedAt DateTime
  content   String?
  status    String   // OK, ERROR, SKIPPED
  notes       String?  // reviewer notesd
  features  Feature[]
  evidences Evidence[]
  meta      Json?
}

model Competitor {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id])
  name        String
  website     String?
  category    String?
  description String?
  isPrimary   Boolean  @default(false)
  meta        Json?
  notes       String?  // reviewer notesd
  pricingPoints PricingPoint[]
  evidences   Evidence[]
competitorCapabilities  CompetitorCapability[]
  @@unique([runId, name])
}

model Feature {
  id           String   @id @default(cuid())
  runId        String
  run          Run      @relation(fields: [runId], references: [id])
  name         String
  normalized   String
  description  String?
  notes       String?  // reviewer notesd
  evidences    Evidence[] 
  sourceId     String
  source       Source   @relation(fields: [sourceId], references: [id])
}

model PricingPoint {
  id             String   @id @default(cuid())
  approved    Boolean  @default(false) // human-in-the-loop approval
  runId          String
  run            Run      @relation(fields: [runId], references: [id])
  competitorId   String
  competitor     Competitor @relation(fields: [competitorId], references: [id])
  planName       String
  priceMonthly   Float?
  priceAnnual    Float?
  transactionFee Float?
  notes          String?
  currency       String?  @default("USD")
  meta           Json?
}

model Evidence {
  id           String   @id @default(cuid())
  runId        String
  run          Run      @relation(fields: [runId], references: [id])
  competitorId String?
  competitor   Competitor? @relation(fields: [competitorId], references: [id])
  featureId    String?
  feature      Feature?  @relation(fields: [featureId], references: [id])
  sourceId     String
  source       Source    @relation(fields: [sourceId], references: [id])
  quote        String
  notes       String?  // reviewer notesd
  selector     String?
  confidence   Float
  publishedAt  DateTime?
}

model Finding {
  id          String   @id @default(cuid())
  runId       String
  run         Run      @relation(fields: [runId], references: [id])
  kind        String   // COMMON_FEATURE, GAP, DIFFERENTIATOR, RISK, RECOMMENDATION
  text        String
  citations   String[]
  confidence  Float
  approved    Boolean  @default(false) // human-in-the-loop approval
  notes       String?  // reviewer notes
}

model Report {
  id         String   @id @default(cuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id])
  runId      String
  run        Run      @relation(fields: [runId], references: [id])
  headline   String
  mdContent  String
  format     String   // MARKDOWN, PDF, NOTION
  createdAt  DateTime @default(now())
  approved   Boolean  @default(false)
  shares     ReportShare[]
}

model Job {
  id         String   @id @default(cuid())
  kind       String   // ORCHESTRATE_RUN
  payload    Json
  status     String   @default("PENDING") // PENDING, RUNNING, DONE, ERROR
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  lastError  String?
}

model CreditLedger {
  id        String   @id @default(cuid())
  userId    String
  month     String   // "2025-11"
  used      Int      @default(0)
  limit     Int      @default(1000)
  updatedAt DateTime @updatedAt

  @@unique([userId, month])
}
model AppSetting {
  key       String  @id
  value     String
  updatedAt DateTime @updatedAt
}
model RunLog {
  id    String @id @default(cuid())
  runId  String
  line   String?
  run     Run @relation(fields: [runId], references: [id])
    createdAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Team Collaboration Models
enum TeamRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  avatar      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  projects Project[]
  members  TeamMember[]
  activities Activity[]
}

model TeamMember {
  id     String   @id @default(cuid())
  teamId String
  userId String
  role   TeamRole @default(VIEWER)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  authorId   String
  author     User     @relation(fields: [authorId], references: [id])
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id])
  runId      String?
  reportId   String?
  parentId   String?  // For threaded comments
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  parent Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")
}

model Activity {
  id         String   @id @default(cuid())
  type       String   // PROJECT_CREATED, RUN_STARTED, REPORT_APPROVED, COMMENT_ADDED, etc.
  message    String
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  teamId     String?
  team       Team?    @relation(fields: [teamId], references: [id])
  projectId  String?
  project    Project? @relation(fields: [projectId], references: [id])
  runId      String?
  reportId   String?
  metadata   Json?    // Additional data for specific activity types
  createdAt  DateTime @default(now())
}

model ApprovalWorkflow {
  id         String         @id @default(cuid())
  projectId  String
  project    Project        @relation(fields: [projectId], references: [id])
  reportId   String?
  runId      String?
  type       String         // REPORT_APPROVAL, PROJECT_APPROVAL, etc.
  status     ApprovalStatus @default(PENDING)
  requestedBy String
  requestedAt DateTime      @default(now())
  reviewedBy String?
  reviewedAt DateTime?
  notes      String?
  metadata   Json?

  reviews ApprovalReview[]
}

model ApprovalReview {
  id                 String         @id @default(cuid())
  approvalWorkflowId String
  approvalWorkflow   ApprovalWorkflow @relation(fields: [approvalWorkflowId], references: [id])
  reviewerId         String
  status             ApprovalStatus
  decision           String?        // APPROVE, REJECT, REQUEST_CHANGES
  notes              String?
  createdAt          DateTime       @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // MENTION, COMMENT_REPLY, APPROVAL_REQUEST, etc.
  title     String
  message   String
  read      Boolean  @default(false)
  metadata  Json?
  createdAt DateTime @default(now())
}

// AI Insights Models
model AIInsight {
  id        String   @id @default(cuid())
  runId     String
  run       Run      @relation(fields: [runId], references: [id])
  type      String   // TREND, PREDICTION, RECOMMENDATION, ANOMALY
  title     String
  content   String
  confidence Float
  metadata  Json?    // AI model, parameters, etc.
  createdAt DateTime @default(now())
}

model NaturalLanguageQuery {
  id        String   @id @default(cuid())
  userId    String
  query     String
  intent    String?  // COMPARE, SEARCH, ANALYZE, etc.
  context   Json?    // Projects, competitors, timeframes
  result    Json?    // Query results
  createdAt DateTime @default(now())
}

// Email Preferences Model
model EmailPreferences {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Notification types
  reportCompletions         Boolean  @default(true)
  monitoringAlerts          Boolean  @default(true)
  teamInvitations           Boolean  @default(true)
  roleChanges               Boolean  @default(true)
  memberRemovals            Boolean  @default(true)
  mentions                  Boolean  @default(true)
  commentReplies            Boolean  @default(true)
  approvalRequests          Boolean  @default(true)

  // Email frequency settings
  weeklyDigest              Boolean  @default(false)
  monthlySummary            Boolean  @default(true)

  // Additional settings
  unsubscribeToken          String   @unique
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// Report Share Model for Public Sharing
model ReportShare {
  id             String    @id @default(cuid())
  reportId       String
  report         Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  projectId      String
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  token          String    @unique
  expiresAt      DateTime?
  password       String?   // Optional password protection
  allowDownload  Boolean   @default(true)
  createdAt      DateTime  @default(now())
  createdById    String
  createdBy      User      @relation(fields: [createdById], references: [id])

  @@index([token])
  @@index([expiresAt])
}